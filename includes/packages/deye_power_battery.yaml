my_deye_power_battery:
  automation:

    # === 1. –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø–∞–ª–æ (—É–±—Ä–∞–Ω—ã –ª–∏—à–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏) ===
    - id: a_power_deye_grid_off
      alias: a_power_deye_grid_off
      initial_state: true
      mode: single
      trigger:
        - platform: state
          entity_id: binary_sensor.deye_grid
          from: "on"
          to: "off"
          for: "00:00:10"
      action:
        - delay: "00:00:05"
        - variables:
            vbat: >-
              {% set v = states('sensor.deye_battery_voltage') %}
              {{ v if v not in ['unknown','unavailable',''] else '' }}
            load_p: >-
              {% set l = states('sensor.load_power') %}
              {{ l if l not in ['unknown','unavailable',''] else '' }}
            nowts: "{{ now().strftime(\"%H:%M' %d.%m\") }}"
        - service: telegram_bot.send_message
          data:
            target:
              - 374673383
              - 496868345
            message: |-
              üö® –°–≤–µ—Ç –ø—Ä–æ–ø–∞–ª
              {% if vbat %}üîã –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ê–ö–ë: {{ vbat }} –í{% endif %}
              {% if load_p %}‚öôÔ∏è –ù–∞–≥—Ä—É–∑–∫–∞: {{ load_p }} –í—Ç{% endif %}
              üïí –í—Ä–µ–º—è: {{ nowts }}

    # === 2. –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (–¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ —Å–µ—Ç–∏ L1) ===
    - id: a_power_deye_grid_on
      alias: a_power_deye_grid_on
      initial_state: true
      mode: single
      trigger:
        - platform: state
          entity_id: binary_sensor.deye_grid
          from: "off"
          to: "on"
          for: "00:00:10"
      action:
        - delay: "00:00:05"
        - variables:
            cap: "{{ states('input_number.battery_capacity_ah') | float(120) }}"
            dur_s: >-
              {{ (as_timestamp(trigger.to_state.last_changed)
               - as_timestamp(trigger.from_state.last_changed)) | int(0) }}
            h: "{{ (dur_s // 3600) | int }}"
            m: "{{ ((dur_s % 3600) // 60) | int }}"
            I: "{{ states('sensor.deye_battery_current') | float(0) }}"
            i_abs: "{{ (I | abs) | round(2) }}"
            vbat: >-
              {% set v = states('sensor.deye_battery_voltage') %}
              {{ v if v not in ['unknown','unavailable',''] else '' }}
            load_p: >-
              {% set l = states('sensor.load_power') %}
              {{ l if l not in ['unknown','unavailable',''] else '' }}
            grid_v: >-
              {% set g = states('sensor.deye_grid_l1_voltage') %}
              {{ g if g not in ['unknown','unavailable',''] else '' }}
            batt_pct: >-
              {% set b = states('sensor.deye_battery') %}
              {{ b if b not in ['unknown','unavailable',''] else '' }}
            nowts: "{{ now().strftime(\"%H:%M' %d.%m\") }}"
        - service: input_number.set_value
          target:
            entity_id: input_number.battery_remaining_ah
          data:
            value: "{{ cap }}"
        - service: telegram_bot.send_message
          data:
            target:
              - 374673383
              - 496868345
            message: |-
              ‚úÖ –°–≤–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
              ‚è± –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –¥–ª–∏–ª–æ—Å—å: {{ h }} —á {{ '%02d' | format(m) }} –º–∏–Ω
              üîå –¢–æ–∫ —Å–µ–π—á–∞—Å: {{ i_abs }} –ê
              {% if batt_pct %}ü™´ –û—Å—Ç–∞—Ç–æ–∫ % –ê–ö–ë: {{ batt_pct }} %{% endif %}
              {% if grid_v %}‚ö° –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —Å–µ—Ç–∏ (L1): {{ grid_v }} –í{% endif %}
              {% if vbat %}üîã –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ê–ö–ë: {{ vbat }} –í{% endif %}
              {% if load_p %}‚öôÔ∏è –ù–∞–≥—Ä—É–∑–∫–∞: {{ load_p }} –í—Ç{% endif %}
              üïí –í—Ä–µ–º—è: {{ nowts }}
